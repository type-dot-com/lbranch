#!/bin/bash
set -e

# lbranch: Link your current work to a Linear issue and name your branch correctly.
#
# Usage:
#   lbranch              # Browse your assigned issues, search, or create new
#   lbranch ENG-142      # Link to a specific issue (any team prefix)
#   lbranch "search terms" # Search for an issue by keyword
#   lbranch -c            # Jump straight to issue creation
#
# Non-interactive mode (for CI):
#   lbranch --auto "task description"  # Auto-creates a Linear issue and branches
#   lbranch --auto ENG-142             # Links to existing issue without prompts
#
# Works whether you're starting fresh on main or already mid-development.
# If you're on a non-main branch, it renames it in place (keeps all commits).

# --- Resolve script location (works with symlinks) ---
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "$0" 2>/dev/null || echo "$0")")" && pwd)"
LIB_DIR="$SCRIPT_DIR/../lib"

# --- Source library modules ---
source "$LIB_DIR/config.sh"
source "$LIB_DIR/linear.sh"
source "$LIB_DIR/git.sh"
source "$LIB_DIR/ui.sh"

# --- Parse flags ---
AUTO_MODE=false
CREATE_MODE=false
if [ "$1" = "--auto" ]; then
  AUTO_MODE=true
  shift
elif [ "$1" = "-c" ]; then
  CREATE_MODE=true
  shift
fi

# --- Initialize ---
check_dependencies
load_config
check_branch_linked

# --- Resolve issue and branch ---
resolve_issue "$@"
update_linear_issue
create_or_rename_branch
print_summary
